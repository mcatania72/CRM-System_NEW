// Jenkinsfile per la FASE 3: CI/CD Base con PostgreSQL

pipeline {
    agent any

    environment {
        COMPOSE_FILE = 'devops-pipeline-fase-2/docker-compose.yml'
        TEST_SCRIPT_PATH = 'devops-pipeline-fase-2/test-containers.sh'
    }

    stages {
        stage('Checkout') {
            steps {
                script {
                    echo '1. Clonazione del repository...'
                    cleanWs()
                    git url: 'https://github.com/mcatania72/CRM-System_NEW.git', branch: 'main'
                }
            }
        }

        // NUOVA FASE DI DEBUG
        stage('Patch Test Script') {
            steps {
                script {
                    echo 'DEBUG: Forzo la correzione dello script di test...'
                    // Uso sed per sostituire la riga errata con quella corretta
                    sh "sed -i 's/w \"%%{\\http_code}\"/w \"%%{http_code}\\